{"version":3,"sources":["meteor://ðŸ’»app/packages/gadicohen_sitemaps/packages/gadicohen_sitemaps.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oG","file":"/packages/gadicohen_sitemaps.js","sourcesContent":["(function () {\n\n/////////////////////////////////////////////////////////////////////////////////////////\n//                                                                                     //\n// packages/gadicohen:sitemaps/sitemaps.js                                             //\n//                                                                                     //\n/////////////////////////////////////////////////////////////////////////////////////////\n                                                                                       //\n/*                                                                                     // 1\n * http://en.wikipedia.org/wiki/Site_map                                               // 2\n * http://www.sitemaps.org/index.html                                                  // 3\n */                                                                                    // 4\n                                                                                       // 5\nsitemaps = {                                                                           // 6\n  _list: {},                                                                           // 7\n  _config: {                                                                           // 8\n    rootUrl: undefined                                                                 // 9\n  },                                                                                   // 10\n  _configHooks: {}                                                                     // 11\n};                                                                                     // 12\n                                                                                       // 13\nfunction configSet(key, value) {                                                       // 14\n  if (sitemaps._configHooks[key])                                                      // 15\n    sitemaps._configHooks[key](key, value, sitemaps._config[key]);                     // 16\n  sitemaps._config[key] = value;                                                       // 17\n}                                                                                      // 18\n                                                                                       // 19\nsitemaps.config = function(key, value) {                                               // 20\n  if (!value && _.isObject(key)) {                                                     // 21\n    for (k in key)                                                                     // 22\n      configSet(k, key[k]);                                                            // 23\n  } else {                                                                             // 24\n    configSet(key, value);                                                             // 25\n  }                                                                                    // 26\n};                                                                                     // 27\n                                                                                       // 28\nif (typeof Number.lpad === \"undefined\") {                                              // 29\n  Number.prototype.lpad = function(length) {                                           // 30\n    \"use strict\";                                                                      // 31\n    var str = this.toString();                                                         // 32\n    while (str.length < length) {                                                      // 33\n      str = \"0\" + str;                                                                 // 34\n    }                                                                                  // 35\n    return str;                                                                        // 36\n  };                                                                                   // 37\n}                                                                                      // 38\n                                                                                       // 39\nvar urlStart = Meteor.absoluteUrl();                                                   // 40\n                                                                                       // 41\nsitemaps._configHooks.rootUrl = function(key, value) {                                 // 42\n  urlStart = value || Meteor.absoluteUrl();                                            // 43\n};                                                                                     // 44\n                                                                                       // 45\nvar prepareUrl = sitemaps._prepareUrl = function(url) {                                // 46\n  if (url.match(/^https?:\\/\\//))                                                       // 47\n    return url;                                                                        // 48\n  else {                                                                               // 49\n    return urlStart + encodeURI(url.replace(/^\\//, '')).replace(/&/g, '&amp;');        // 50\n  }                                                                                    // 51\n};                                                                                     // 52\n                                                                                       // 53\n// TODO: 1) gzip, 2) sitemap index + other types + sitemap for old content             // 54\nvar Fiber = Npm.require('fibers');                                                     // 55\nWebApp.connectHandlers.use(function(req, res, next) {                                  // 56\n  new Fiber(function() {                                                               // 57\n    \"use strict\";                                                                      // 58\n    var out, pages, urls;                                                              // 59\n                                                                                       // 60\n    urls = _.keys(sitemaps._list);                                                     // 61\n    if (!_.contains(urls, req.url))                                                    // 62\n      return next();                                                                   // 63\n                                                                                       // 64\n    pages = sitemaps._list[req.url];                                                   // 65\n    if (_.isFunction(pages))                                                           // 66\n      pages = pages();                                                                 // 67\n    else if (!_.isArray(pages))                                                        // 68\n      throw new TypeError(\"sitemaps.add() expects an array or function\");              // 69\n                                                                                       // 70\n    // The header is added later once we know which namespaces we need                 // 71\n    out = '';                                                                          // 72\n    var namespaces = {};                                                               // 73\n                                                                                       // 74\n    var w3cDateTimeTS, date;                                                           // 75\n    _.each(pages, function(page) {                                                     // 76\n                                                                                       // 77\n      out += '  <url>\\n'                                                               // 78\n        + '    <loc>' + prepareUrl(page.page) + '</loc>\\n';                            // 79\n                                                                                       // 80\n      if (page.lastmod) {                                                              // 81\n        date = new Date(page.lastmod);                                                 // 82\n        w3cDateTimeTS = date.getUTCFullYear() + '-'                                    // 83\n          + (date.getUTCMonth()+1).lpad(2) + '-'                                       // 84\n          + date.getUTCDate().lpad(2) + 'T'                                            // 85\n          + date.getUTCHours().lpad(2) + ':'                                           // 86\n          + date.getUTCMinutes().lpad(2) + ':'                                         // 87\n          + date.getUTCSeconds().lpad(2) + '+00:00';                                   // 88\n        out += '    <lastmod>' + w3cDateTimeTS + '</lastmod>\\n';                       // 89\n      }                                                                                // 90\n                                                                                       // 91\n      if (page.changefreq)                                                             // 92\n        out += '    <changefreq>' + page.changefreq + '</changefreq>\\n';               // 93\n                                                                                       // 94\n      if (page.priority)                                                               // 95\n        out += '    <priority>' + page.priority + '</priority>\\n';                     // 96\n                                                                                       // 97\n      if (page.xhtmlLinks) {                                                           // 98\n        namespaces.xhtml = true;                                                       // 99\n        if (!_.isArray(page.xhtmlLinks))                                               // 100\n          page.xhtmlLinks = [page.xhtmlLinks];                                         // 101\n        _.each(page.xhtmlLinks, function(link) {                                       // 102\n          out += '    <xhtml:link \\n';                                                 // 103\n          if (link.href)                                                               // 104\n            link.href = prepareUrl(link.href);                                         // 105\n          for (var key in link)                                                        // 106\n            out += '      ' + key + '=\"' + link[key] + '\"\\n';                          // 107\n          out += '      />\\n';                                                         // 108\n        });                                                                            // 109\n      }                                                                                // 110\n                                                                                       // 111\n      _.each(['image', 'video'], function(tag) {                                       // 112\n        var tagS = tag+'s';                                                            // 113\n        if (page[tagS]) {                                                              // 114\n          namespaces[tag] = true;                                                      // 115\n          if (!_.isArray(page[tagS]))                                                  // 116\n            page[tagS] = [page[tagS]];                                                 // 117\n                                                                                       // 118\n          _.each(page[tagS], function(data) {                                          // 119\n            out += '      <'+tag+':'+tag+'> \\n';                                       // 120\n                                                                                       // 121\n            for (var key in data) {                                                    // 122\n              if (key == 'loc' || key.match(/_loc$/))                                  // 123\n                data[key] = prepareUrl(data[key]);                                     // 124\n              out += '        <'+tag+':'+key+'>' + data[key] + '</'+tag+':'+key+'>\\n'; // 125\n            }                                                                          // 126\n                                                                                       // 127\n            out += '      </'+tag+':'+tag+'> \\n';                                      // 128\n          });                                                                          // 129\n        }                                                                              // 130\n      });                                                                              // 131\n                                                                                       // 132\n      out  += '   </url>\\n\\n';                                                         // 133\n    });                                                                                // 134\n                                                                                       // 135\n    out += '</urlset>\\n';                                                              // 136\n                                                                                       // 137\n    // We do this last so we know which namesapces to add                              // 138\n    var header = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n'                            // 139\n      + '<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"';                 // 140\n                                                                                       // 141\n    if (namespaces.xhtml)                                                              // 142\n      header += '\\n  xmlns:xhtml=\"http://www.w3.org/1999/xhtml\"';                      // 143\n    if (namespaces.image)                                                              // 144\n      header += '\\n  xmlns:image=\"http://www.google.com/schemas/sitemap-image/1.1\"';   // 145\n    if (namespaces.video)                                                              // 146\n      header += '\\n  xmlns:video=\"http://www.google.com/schemas/sitemap-video/1.1\"';   // 147\n    header += '>\\n';                                                                   // 148\n                                                                                       // 149\n    out = header + out;                                                                // 150\n                                                                                       // 151\n    res.writeHead(200, {'Content-Type': 'application/xml'});                           // 152\n    res.end(out, 'utf8');                                                              // 153\n    return;                                                                            // 154\n  }).run();                                                                            // 155\n});                                                                                    // 156\n                                                                                       // 157\nsitemaps.add = function(url, func) {                                                   // 158\n  \"use strict\";                                                                        // 159\n  check(url, String);                                                                  // 160\n  if (url.charAt(0) !== '/')                                                           // 161\n    url = '/' + url;                                                                   // 162\n                                                                                       // 163\n  sitemaps._list[url] = func;                                                          // 164\n  robots.addLine('Sitemap: ' + prepareUrl(url));                                       // 165\n};                                                                                     // 166\n                                                                                       // 167\n/*                                                                                     // 168\nsitemaps.add('/sitemap.xml', function() {                                              // 169\n  // 'page' is reqired                                                                 // 170\n  // 'lastmod', 'changefreq', 'priority' are optional.                                 // 171\n  return [                                                                             // 172\n    { page: 'x', lastmod: new Date().getTime() },                                      // 173\n    { page: 'y', lastmod: new Date().getTime(), changefreq: 'monthly' },               // 174\n    { page: 'z', lastmod: new Date().getTime(), changefreq: 'monthly', priority: 0.8 } // 175\n  ];                                                                                   // 176\n});                                                                                    // 177\n*/                                                                                     // 178\n                                                                                       // 179\n/////////////////////////////////////////////////////////////////////////////////////////\n\n}).call(this);\n"]}